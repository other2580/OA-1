<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="oa.dao.DocumentDao">
	<!-- 添加文件 -->
	<insert id="add" parameterType="Document" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO Document(NAME,Description,CreatorId,CreateTime,TYPE,FileUrl,ParentId)
			VALUES(#{name}, #{description}, #{creator.id}, #{createTime}, #{type}, #{fileUrl}, #{parent.id})
	</insert>
	<!-- 删除文件 -->
	<delete id="delete" parameterType="int">
		DELETE FROM Document WHERE id = #{id} OR ParentId = #{id}
	</delete>
	<!-- 修改文件信息 -->
	<update id="update" parameterType="Document">
		UPDATE Document
		<set>
			<if test="name != null">name = #{name},</if>
			<if test="description != null">description = #{description},</if>
			<if test="creator != null">creatorId = #{creator.id},</if>
			<if test="createTime != null">createTime = #{createTime},</if>
			<if test="type != null">type = #{type},</if>
			<if test="fileUrl != null">fileUrl = #{fileUrl},</if>
			<if test="parent != null">parentId = #{parent.id},</if>
		</set>
		<where>
			id = #{id}
		</where>
	</update>
	
	<resultMap type="Document" id="DocumentResultMap">
		<id column="id" property="id"/>
		<result column="name" property="name"/>
		<result column="description" property="description"/>
		<result column="createTime" property="createTime"/>
		<result column="type" property="type"/>
		<result column="fileUrl" property="fileUrl"/>
		
		<!-- 加载创建者 -->
		<association property="creator" column="creatorId" 
			javaType="Employee" select="oa.dao.EmployeeDao.fetchEmployeeById" />
		<!-- 加载父级对象 -->
		<association property="parent" column="id" 
			javaType="Document" select="fetchDocumentById" />
		<!-- 加载子节点 -->
		<collection property="documents" column="id" 
			ofType="Document" select="fetchChildrenDocuments" />
	</resultMap>
	
	<!-- 查找全部根节点 -->
	<select id="fetchAllDocument" resultMap="DocumentResultMap">
		SELECT * FROM Document WHERE ParentId = 0
	</select>
	
	<!-- 根据文件Id 查找文件 -->
	<select id="fetchDocumentById" resultMap="DocumentResultMap" parameterType="int">
		SELECT * FROM Document WHERE id = #{id}
	</select>
	
	<!-- 查询子节点 -->
	<select id="fetchChildrenDocuments" resultMap="DocumentResultMap" parameterType="int">
		SELECT * FROM Document WHERE parentId = #{parentId}
	</select>
</mapper>
